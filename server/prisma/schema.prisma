// schema.prisma
generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  // Enable UUID extension once in your DB (via migration or manually)
  // CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
}

// ============================================
// USER & AUTHENTICATION
// ============================================
model users {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firebase_uid  String         @unique @map("firebase_uid")
  email         String         @unique
  display_name  String?        @map("display_name")
  avatar        String?
  first_name    String?        @map("first_name")
  last_name     String?        @map("last_name")
  photo_url     String?        @map("photo_url")
  phone         String?
  bio           String?
  company_id    String?        @db.Uuid
  created_at    DateTime       @default(now()) @map("created_at")
  updated_at    DateTime       @default(now()) @updatedAt @map("updated_at")
  last_login    DateTime?      @map("last_login")
  terms_accepted   Boolean?       @map("terms_accepted")
  terms_accepted_at DateTime?     @map("terms_accepted_at")

  // Relations
  company       companies?     @relation("user_company", fields: [company_id], references: [id])
  settings      user_settings?
  team_members  team_members[] @relation("user_team_members")
  tasks         tasks[]        @relation("task_assignees")
  subtasks      subtasks[]     @relation("subtask_assignee")
  comments      comments[]     @relation("comment_author")
  notes         notes[]        @relation("note_author")
  assets        assets[]       @relation("asset_uploader")
  notifications notifications[] @relation("user_notifications")

  @@map("users")
  @@index([firebase_uid])
  @@index([email])
}

// ============================================
// COMPANY
// ============================================
model companies {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  created_at  DateTime     @default(now()) @map("created_at")
  updated_at  DateTime     @default(now()) @updatedAt @map("updated_at")

  users       users[]      @relation("user_company")
  team_members team_members[] @relation("company_team_members")
  projects    projects[]   @relation("company_projects")
  tasks       tasks[]      @relation("company_tasks")
  subtasks    subtasks[]   @relation("company_subtasks")
  assets      assets[]     @relation("company_assets")
  comments    comments[]   @relation("company_comments")
  notes       notes[]      @relation("company_notes")
  clients     clients[]    @relation("company_clients")
  project_team_members project_team_members[] @relation("company_project_team_members")

  @@map("companies")
  @@index([name])
}

// ============================================
// CLIENTS
// ============================================
model clients {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id  String    @db.Uuid
  name        String
  email       String?
  phone       String?
  address     String?
  created_at  DateTime  @default(now()) @map("created_at")
  updated_at  DateTime  @default(now()) @updatedAt @map("updated_at")

  company     companies @relation("company_clients", fields: [company_id], references: [id], onDelete: Cascade)
  projects    projects[] @relation("client_projects")

  @@map("clients")
  @@index([company_id])
  @@index([name])
}

// ============================================
// TEAM MEMBERS
// ============================================
model team_members {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String?   @db.Uuid
  company_id  String    @db.Uuid
  email       String
  role        String
  access      String    @default("team_member")
  status      String    @default("active")
  last_login  DateTime? @map("last_login")
  created_at  DateTime  @default(now()) @map("created_at")
  updated_at  DateTime  @default(now()) @updatedAt @map("updated_at")
  user        users?    @relation("user_team_members", fields: [user_id], references: [id], onDelete: SetNull)
  company     companies @relation("company_team_members", fields: [company_id], references: [id], onDelete: Cascade)

  task_assignments   task_team_member_assignees[] @relation("task_team_member_assignees")
  project_memberships project_team_members[]       @relation("project_team_members")

  @@map("team_members")
  @@unique([email, company_id])
  @@index([company_id])
  @@index([user_id])
}

// ============================================
// PROJECTS
// ============================================
model projects {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id  String    @db.Uuid
  client_id   String?   @db.Uuid
  title       String
  description String?
  status      String    @default("Planning")
  deadline    DateTime?
  created_at  DateTime  @default(now()) @map("created_at")
  updated_at  DateTime  @default(now()) @updatedAt @map("updated_at")

  company     companies   @relation("company_projects", fields: [company_id], references: [id], onDelete: Cascade)
  client      clients?    @relation("client_projects", fields: [client_id], references: [id], onDelete: SetNull)

  tasks       tasks[]       @relation("project_tasks")
  assets      assets[]      @relation("project_assets")
  comments    comments[]    @relation("project_comments")
  notes       notes[]       @relation("project_notes")
  team_members project_team_members[] @relation("project_team_members")

  @@map("projects")
  @@index([company_id])
  @@index([client_id])
  @@index([status])
}

// Junction: Project ↔ TeamMember
model project_team_members {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id     String    @db.Uuid
  project_id      String    @db.Uuid
  team_member_id  String    @db.Uuid
  role            String?
  joined_at       DateTime  @default(now()) @map("joined_at")

  project         projects     @relation("project_team_members", fields: [project_id], references: [id], onDelete: Cascade)
  team_member     team_members @relation("project_team_members", fields: [team_member_id], references: [id], onDelete: Cascade)
  company         companies    @relation("company_project_team_members", fields: [company_id], references: [id], onDelete: Cascade)

  @@map("project_team_members")
  @@unique([project_id, team_member_id])
  @@index([company_id])
  @@index([project_id])
  @@index([team_member_id])
}

// ============================================
// TASKS
// ============================================
model tasks {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id  String    @db.Uuid
  project_id  String    @db.Uuid
  title       String
  description String?
  status      String    @default("To-Do")
  priority    String    @default("medium")
  due_date    DateTime? @map("due_date")
  progress    Int       @default(0)
  created_at  DateTime  @default(now()) @map("created_at")
  updated_at  DateTime  @default(now())  @updatedAt @map("updated_at")

  company     companies   @relation("company_tasks", fields: [company_id], references: [id], onDelete: Cascade)
  project     projects    @relation("project_tasks", fields: [project_id], references: [id], onDelete: Cascade)

  assignees           users[]                   @relation("task_assignees")
  team_member_assignees task_team_member_assignees[] @relation("task_team_member_assignees")
  subtasks            subtasks[]                @relation("task_subtasks")
  comments            comments[]                @relation("task_comments")
  assets              assets[]                  @relation("task_assets")
  tags                task_tags[]               @relation("task_tags")

  @@map("tasks")
  @@index([company_id])
  @@index([project_id])
  @@index([status])
  @@index([priority])
}

// Junction: Task ↔ TeamMember (assignee)
model task_team_member_assignees {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id     String    @db.Uuid
  project_id      String    @db.Uuid
  task_id         String    @db.Uuid
  team_member_id  String    @db.Uuid
  assigned_at     DateTime  @default(now()) @map("assigned_at")

  task            tasks        @relation("task_team_member_assignees", fields: [task_id], references: [id], onDelete: Cascade)
  team_member     team_members @relation("task_team_member_assignees", fields: [team_member_id], references: [id], onDelete: Cascade)

  @@map("task_team_member_assignees")
  @@unique([task_id, team_member_id])
  @@index([task_id])
  @@index([team_member_id])
}

model task_tags {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  task_id String @db.Uuid
  tag     String

  task    tasks  @relation("task_tags", fields: [task_id], references: [id], onDelete: Cascade)

  @@map("task_tags")
  @@index([task_id])
}

// ============================================
// SUBTASKS
// ============================================
model subtasks {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id  String   @db.Uuid
  task_id     String   @db.Uuid
  user_id     String   @db.Uuid
  title       String
  completed   Boolean  @default(false)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @default(now()) @updatedAt @map("updated_at")

  company     companies @relation("company_subtasks", fields: [company_id], references: [id], onDelete: Cascade)
  task        tasks     @relation("task_subtasks", fields: [task_id], references: [id], onDelete: Cascade)
  user        users     @relation("subtask_assignee", fields: [user_id], references: [id], onDelete: Cascade)

  @@map("subtasks")
  @@index([company_id])
  @@index([task_id])
}

// ============================================
// ASSETS (FILES)
// ============================================
model assets {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id    String    @db.Uuid
  project_id    String    @db.Uuid
  task_id       String?   @db.Uuid
  uploaded_by_id String   @db.Uuid @map("uploaded_by_id")
  name          String
  size          String
  type          String
  url           String
  upload_date   DateTime  @default(now()) @map("upload_date")
  updated_at    DateTime  @default(now()) @updatedAt @map("updated_at")

  company       companies @relation("company_assets", fields: [company_id], references: [id], onDelete: Cascade)
  project       projects  @relation("project_assets", fields: [project_id], references: [id], onDelete: Cascade)
  task          tasks?    @relation("task_assets", fields: [task_id], references: [id], onDelete: SetNull)
  uploaded_by   users     @relation("asset_uploader", fields: [uploaded_by_id], references: [id], onDelete: Cascade)

  @@map("assets")
  @@index([company_id])
  @@index([project_id])
  @@index([task_id])
  @@index([uploaded_by_id])
}

// ============================================
// COMMENTS
// ============================================
model comments {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id  String    @db.Uuid
  project_id  String    @db.Uuid
  task_id     String?   @db.Uuid
  author_id   String    @db.Uuid
  content     String
  timestamp   DateTime  @default(now())
  updated_at  DateTime  @default(now()) @updatedAt @map("updated_at")

  company     companies @relation("company_comments", fields: [company_id], references: [id], onDelete: Cascade)
  project     projects  @relation("project_comments", fields: [project_id], references: [id], onDelete: Cascade)
  task        tasks?    @relation("task_comments", fields: [task_id], references: [id], onDelete: SetNull)
  author      users     @relation("comment_author", fields: [author_id], references: [id], onDelete: Cascade)

  @@map("comments")
  @@index([company_id])
  @@index([project_id])
  @@index([task_id])
  @@index([author_id])
}

// ============================================
// NOTES
// ============================================
model notes {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id  String    @db.Uuid
  project_id  String    @db.Uuid
  author_id   String    @db.Uuid
  title       String
  visibility  String    @default("private")
  content     String
  created_at  DateTime  @default(now()) @map("created_at")
  updated_at  DateTime  @default(now()) @updatedAt @map("updated_at")

  company     companies @relation("company_notes", fields: [company_id], references: [id], onDelete: Cascade)
  project     projects  @relation("project_notes", fields: [project_id], references: [id], onDelete: Cascade)
  author      users     @relation("note_author", fields: [author_id], references: [id], onDelete: Cascade)
  tags        note_tags[] @relation("note_tags")

  @@map("notes")
  @@index([company_id])
  @@index([project_id])
  @@index([author_id])
}

model note_tags {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id String @db.Uuid
  note_id String @db.Uuid
  tag     String

  note    notes  @relation("note_tags", fields: [note_id], references: [id], onDelete: Cascade)

  @@map("note_tags")
  @@index([note_id])
}

// ============================================
// NOTIFICATIONS
// ============================================
model notifications {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  type       String
  title      String
  message    String
  read       Boolean  @default(false)
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @default(now()) @updatedAt @map("updated_at")

  user       users    @relation("user_notifications", fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([user_id])
  @@index([read])
}

// ============================================
// USER SETTINGS
// ============================================
model user_settings {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                String   @unique @db.Uuid
  theme                  String   @default("light")
  language               String   @default("en")
  notifications_enabled  Boolean  @default(true) @map("notifications_enabled")
  compact_mode           Boolean  @default(false) @map("compact_mode")
  created_at             DateTime @default(now()) @map("created_at")
  updated_at             DateTime @default(now()) @updatedAt @map("updated_at")

  user                   users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_settings")
  @@index([user_id])
}